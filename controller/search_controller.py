from flask import Blueprint, request, jsonify, current_app
from model.search.main import search,add_movie_metadata,add_person_metadata

search_blueprint = Blueprint('search', __name__)

@search_blueprint.route('/search', methods=['POST'])
def handle_search():

    print("REQUESTEN: ")
    print(request.json)


    #get json data from request 
    data = request.get_json()
    query = data.get('query', '').strip()
    search_type = data.get('type', '').strip().lower() #fallback to movies if no type provided

    print(search_type)
    #validate length
    if len(query) < 3:
        return jsonify({'error': 'Query must be at least 3 characters long'}), 400

    if search_type == 'movie':
        results = add_movie_metadata(search(query=query, searchable_data=current_app.config['SEARCHABLE_MOVIES']))
    elif search_type == 'actor':
        results = add_person_metadata(search(query=query, searchable_data=current_app.config['SEARCHABLE_ACTORS']))
    elif search_type == 'director':
        results = add_person_metadata(search(query=query, searchable_data=current_app.config['SEARCHABLE_DIRECTORS']))
    return jsonify({'results': results})

    #[{'title': 'The Avengers', 'score': 100.0, 'uri': 'http://www.wikidata.org/entity/Q494985', 'ratings': 4.395, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//1p5thyQ4pCy876HpdvFARqJ62N9.jpg'}, {'title': 'Haven', 'score': 88.88888888888889, 'uri': 'http://www.wikidata.org/entity/Q94284', 'ratings': 5.3, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//cV6rQ2wPN5I58d34DHyFAmO36BF.jpg'}, {'title': 'Texas Rangers', 'score': 85.71428571428572, 'uri': 'http://www.wikidata.org/entity/Q368421', 'ratings': 6.1, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//69tMHlxiCYlYKGZm1aPH1u7hY88.jpg'}, {'title': "Darby's Rangers", 'score': 85.71428571428572, 'uri': 'http://www.wikidata.org/entity/Q373688', 'ratings': 5.9, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//eUTRFjBP6BbQlya3FBTHRdnkSQ2.jpg'}, {'title': 'Dave', 'score': 85.71428571428572, 'uri': 'http://www.wikidata.org/entity/Q539658', 'ratings': 6.6, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//wIUuf1NFchdCJe833JBTiSMzqfv.jpg'}, {'title': 'Vengo', 'score': 80.0, 'uri': 'http://www.wikidata.org/entity/Q151643', 'ratings': 7.0, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//wgWcaqcqZc1ZPNwjgdpbCKoFfNd.jpg'}, {'title': "Puppet Master III: Toulon's Revenge", 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q127439', 'ratings': 6.3, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//uSSZGAEnSJ8ov81i7UVYcFOeThP.jpg'}, {'title': 'AngÃ©lique, Marquise des Anges', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q94943', 'ratings': 6.7, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//lBPpq9f5FNa1fgbcguVh9cOzfg0.jpg'}, {'title': 'Hello Stranger', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q115749', 'ratings': 7.2, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//ypaXllTlLV9tFsJkLX7674isxk9.jpg'}, {'title': 'Raise Ravens', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q150881', 'ratings': 7.573, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//hueMt6pkaV8nwVGwKP2uuiqF5DJ.jpg'}, {'title': 'Nathalie Granger', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q478423', 'ratings': 6.1, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//jystgUUhYMIpAH72h3z5TaSxqey.jpg'}, {'title': 'The Woman and the Stranger', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q480773', 'ratings': 4.4, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//nFA3TcwhZzGKUfm5Aam8tRHz6Vw.jpg'}, {'title': "Sophie's Revenge", 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q485527', 'ratings': 5.8, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//3EwvZJpDdRDc5hnhgvVtbbqZ0oh.jpg'}, {'title': 'The Messenger', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q466358', 'ratings': 6.7, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//p4fJyH7mMbasiFYwiw2nE7D6pMY.jpg'}, {'title': 'Love and Anger', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q365028', 'ratings': 5.3, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//5Zjd6dwTpmIyg0rLZ3zCBzbpYpr.jpg'}, {'title': 'Tintin and the Blue Oranges', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q370830', 'ratings': 5.0, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//xlYgA1tFhIre1Ou4apLyvXWZDNF.jpg'}, {'title': 'Vengeance Valley', 'score': 76.92307692307692, 'uri': 'http://www.wikidata.org/entity/Q542215', 'ratings': 5.3, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//yIiXDUWV2ka5116V4snpCBRsn0b.jpg'}, {'title': 'Die Hard with a Vengeance', 'score': 75.0, 'uri': 'http://www.wikidata.org/entity/Q106871', 'ratings': 7.272, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//buqmCdFQEWwEpL3agGgg2GVjN2d.jpg'}, {'title': 'Amen', 'score': 75.0, 'uri': 'http://www.wikidata.org/entity/Q462025', 'ratings': 5.6, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//weM4n1OhGPHiVr7qMnllWlsSbeU.jpg'}, {'title': 'Passenger 57', 'score': 75.0, 'uri': 'http://www.wikidata.org/entity/Q325691', 'ratings': 5.974, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//4VBN8pQxGHjeZWcNv1V1xSw0OKC.jpg'}, {'title': 'Alive', 'score': 75.0, 'uri': 'http://www.wikidata.org/entity/Q332798', 'ratings': 6.882, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//uQACcCZqd7WCTRin9xRIW5gr1bd.jpg'}, {'title': 'Strangers on a Train', 'score': 75.0, 'uri': 'http://www.wikidata.org/entity/Q499639', 'ratings': 7.663, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//ihC083U7ef56Ui4x0P0dobojrZ1.jpg'}, {'title': "Charlie's Angels", 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q229599', 'ratings': 5.837, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//iHTmZs0BmkwMCYi8rhvMWC5G4EM.jpg'}, {'title': 'Men and Banners', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q468331', 'ratings': 6.2, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//9eXlN9Yw7tDGF2fu2O17d5gjXum.jpg'}, {'title': 'Andersrum', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q491705', 'ratings': 0.0, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original/None'}, {'title': 'Dulhan Hum Le Jayenge', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q492134', 'ratings': 5.6, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//xC05yY7nXCOMh31NvBQhHO4Qg4x.jpg'}, {'title': 'Tumko Na Bhool Paayenge', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q495113', 'ratings': 5.9, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//mI4cFL7bEQcTgI6vtoPSkAWU1tJ.jpg'}, {'title': 'House of Flying Daggers', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q369388', 'ratings': 7.3, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//93feGsGiCtG5ymrRcErUgBsdo6v.jpg'}, {'title': 'Angels Over Broadway', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q537237', 'ratings': 5.8, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//nee1LVYfgKE6fWrXNzi94fl2PAR.jpg'}, {'title': 'City of Angels', 'score': 71.42857142857143, 'uri': 'http://www.wikidata.org/entity/Q168010', 'ratings': 6.796, 'media_type': 'movie', 'poster': 'https://image.tmdb.org/t/p/original//iuzxpUjHsbQJXV3kB9ZAdCimM60.jpg'}]

    

